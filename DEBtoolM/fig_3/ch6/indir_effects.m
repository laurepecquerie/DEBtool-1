%% fig:indir_effects
%% bib: Data from OECD ring test
%% out:m3l27d2,m4l27d2,m5l27d2

%% Effect of 3,4-dichloroaniline on reproduction of Daphnia magna

t = (1:21)'; % d
c = [0 3.2 5.6 10 18 32]'; % mug/l

%% c = 0; reproduction of 10 individuals
R0 = [0 0 0 0 0 0 0 0 14  0  0 25  0  0  0 14  0  0 24  0  0;
      0 0 0 0 0 0 0 0 10  0  0 22  0  0 18  0  0  0 33  0  0;
      0 0 0 0 0 0 0 0  0  0  5  0  0  8  0  0  0 20  0  0  0;
      0 0 0 0 0 0 0 0 12  0  0 23  0  0  0 16  0  0 32  0  0;
      0 0 0 0 0 0 0 0 12  0  0 21  0  0  0 19  0  0 11 18  0;
      0 0 0 0 0 0 0 0  5  0  0 19  0  0  0 14  0  0 35  0  0;
      0 0 0 0 0 0 0 0  9  0  0  0 24  0  0 15  0  0  0 28  0;
      0 0 0 0 0 0 0 0  7  0  0 21  0  0  0 20  0  0 35  0  0;
      0 0 0 0 0 0 0 0  5  0  0 19  0  0  0 13  0  0 36  0  0;
      0 0 0 0 0 0 0 0  8  0  0 19  0  0  0 24  0  0 27  0  0];

%% c = 0; survival of 10 individuals
S0 = [1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1];

%% c = 3.2; reproduction of 10 individuals
R3 = [0 0 0 0 0 0 0 0  6  0  0 19  0  0 16  0  0  0 31  0  0;
      0 0 0 0 0 0 0 0  8  0  0 19  0  0 21  0  0  0 32  0  0;
      0 0 0 0 0 0 0 0 11  0  0 20  0  0  0 24  0  0 26  0  0;
      0 0 0 0 0 0 0 0  3  0  0 22  4  0  0 13  0  0 33  0  0;
      0 0 0 0 0 0 0 0  6  0  0 20  0  0  0 13  0  0 29  0  0;
      0 0 0 0 0 0 0 0  5  0  0 18  0  0 16  0  0  0 32  0  0;
      0 0 0 0 0 0 0 0 14  0  0 21  0  0  0 21  0  0 28  0  0;
      0 0 0 0 0 0 0 0  8  0  0 19  0  0  0 22  0  0 35  0  0;
      0 0 0 0 0 0 0 0 10  0  0  0  8  0  0 28  0  0  0 18  0;
      0 0 0 0 0 0 0 0  8  0  0 21  0  0  0 22  0  0 21  0  0];

%% c = 3.2; survival of 10 individuals
S3 = [1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1];

%% c = 5.6; reproduction of 10 individuals
R5 = [0 0 0 0 0 0 0 0  7  0  0 21  0  0  0 10  0  0 30  0  0;
      0 0 0 0 0 0 0 0  3  0  0 16  0  0  0 18  0  0 33  0  0;
      0 0 0 0 0 0 0 0  5  0  0 23  0  0  0 11  0  0 31  0  0;
      0 0 0 0 0 0 0 0  8  0  0 20  0  0  0 16  0  0 34  0  0;
      0 0 0 0 0 0 0 0  2  0  0 22  0  0  0 20  0  0  7  0  0;
      0 0 0 0 0 0 0 0  3  0  0  7  8  0  0 16  0  0 19  0  0;
      0 0 0 0 0 0 0 0  3  0  0 18  0  0  0  7  0  0 35  0  0;
      0 0 0 0 0 0 0 0  9  0  0 17  0  0  0 20  0  0 33  0  0;
      0 0 0 0 0 0 0 0  3  0  0 11  0  0 15  0  0  0 27  0  0;
      0 0 0 0 0 0 0 0  3  0  0 16  0  0  0 17  0  0 12  0  0];

%% c = 5.6; survival of 10 individuals
S5 = [1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
      1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1];

%% c = 10; reproduction of 10 individuals
R10 = [0 0 0 0 0 0 0 0  0  0  0 15  0  0  0 11  0  0 27  0  0;
       0 0 0 0 0 0 0 0  0  0  0 12  0  0  0 14  0  0 32  0  0;
       0 0 0 0 0 0 0 0  0  0  0 15  0  0  0 18  0  0 34  0  0;
       0 0 0 0 0 0 0 0  1  0  0 15  0  0  0 20  0  0 30  0  0;
       0 0 0 0 0 0 0 0  0  0  0 10  0  0  0 13  0  0 24  0  0;
       0 0 0 0 0 0 0 0  0  0  0 11  0  0  0 15  0  0 20  0  0;
       0 0 0 0 0 0 0 0  0  6  0  0  0 10  0  0 21  0  0  0  9;
       0 0 0 0 0 0 0 0  0  0  0 12  0  0  0 16  0  0 27  0  0;
       0 0 0 0 0 0 0 0  2  0  0 18  0  0  0 15  0  0 27  0  0;
       0 0 0 0 0 0 0 0  0  0  0  7  0  0  0 15  0  0 15  0  0];

%% c = 10; survival of 10 individuals
S10 = [1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1];

%% c = 18; reproduction of 10 individuals
R18 = [0 0 0 0 0 0 0 0  0  0  0 10  0  0  0 14  0  0  8  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  9  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  5  0  0  0  5  0  0  7  0  0;
       0 0 0 0 0 0 0 0  0  0  0  7  0  0  0  5  0  0  4  0  0;
       0 0 0 0 0 0 0 0  0  0  0  8  0  0  0  4  0  0 12  0  0;
       0 0 0 0 0 0 0 0  0  0  0  2  0  0  0  1  0  0 18  0  0;
       0 0 0 0 0 0 0 0  1  0  0  5  0  0  0  9  0 26  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  2  0  0  0 14  0  0 13  0  0;
       0 0 0 0 0 0 0 0  0  0  0  1  0  0  0  3  0  0 18  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  2  0  0  5  0  0];

%% c = 18; survival of 10 individuals
S18 = [1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1];

%% c = 32; reproduction of 10 individuals
R32 = [0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  1  0  0  0  0  0  0  0  0;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  1;
       0 0 0 0 0 0 0 0  0  0  0  0  0  0  0  0  0  0  0  0  0];

%% c = 32; survival of 10 individuals
S32 = [1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  0  0  0  0  0  0  0  0;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  0  0  0  0  0  0  0  0  0;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  0  0  0  0  0  0;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  1  1  1  1  1  1  1  1  1;
       1 1 1 1 1 1 1 1  1  1  1  1  0  0  0  0  0  0  0  0  0];

%% reformat data for parameter estimation
% mean cumulated offspring per female; time (dim 1) versus conc (dim 2)
R = [sum(R0,1); sum(R3,1); sum(R5,1); sum(R10,1); sum(R18,1); sum(R32,1)]';
S = [sum(S0,1); sum(S3,1); sum(S5,1); sum(S10,1); sum(S18,1); sum(S32,1)]';
R = cumsum(R ./ S, 1);

par_txt = {'NEC'; 'tolerance conc'; 'elimination rate'; ...
	   'allocation fraction'; 'reprod efficiency'; 'investment ratio'; ...
	   'mat rate coeff'; 'som rate coeff'; 'energy conductance'; ...
           'scaled mat at birth'; 'scaled mat at puberty'; 'init body length'};

       nmregr_options('default')
% nmregr_options('max_step_number',10)

shregr2_options('default');
shregr2_options('plotnr',1);

%% assimilation model
p_as = [ 3.198 1;  169.157 1;  1e8 0;
	   .8 0;   .95 0;  .15 0;
	  3.6 0;   4.1 0; 1.62 0;
	 .002 1;  .1818 1;  0.8 0];
p_as = nmregr2('asirep', p_as, t, c, R);
[cov, cor, sd, ssq] = pregr2('asirep', p_as, t, c, R);
fprintf('assimilation model \n');
printpar(par_txt, p_as, sd);

shregr2('asirep', p_as, t, c, R);
title('D. magna in 3,4-dichloroaniline; assimilation model')
% gset output 'm5l27d2.ps'

fprintf('hit a key to proceed \n');
pause;

%% maintenance model
p_ma = [ 3.17 1;  87.04 1;  1e8 0;
	   .8 0;   .95 0;  .15 0;
	  3.6 0;   4.1 0; 1.62 0;
	 .0021 1;  .176 1;  0.8 0];

p_ma = nmregr2('mairep', p_ma, t, c, R);
[cov, cor, sd, ssq] = pregr2('mairep', p_ma, t, c, R);
fprintf('maintenance model \n');
printpar(par_txt, p_ma, sd);

shregr2('mairep',p_ma, t, c, R);
title('D. magna in 3,4-dichloroaniline; maintenance model')
% gset output 'm3l27d2.ps'

fprintf('hit a key to proceed \n');
pause;

%% growth model
p_gr = [ 0 0;  0.81 1;  1e8 0;
	   .8 0;   .95 0;  .15 0;
	  3.6 0;   4.1 0; 1.62 0;
	 .0037 1;  .1186 1;  0.8 0];

p_gr = nmregr2('grirep', p_gr, t, c, R);
[cov, cor, sd, ssq] = pregr2('grirep', p_gr, t, c, R);
fprintf('growth model \n');
printpar(par_txt, p_gr, sd);

shregr2('grirep', p_gr, t, c, R);
title('D. magna in 3,4-dichloroaniline; growth model')
% gset output 'm4l27d2.ps'
